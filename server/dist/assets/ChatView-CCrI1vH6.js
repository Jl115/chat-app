import{_ as V,d as W,r as k,o as l,c as R,w as M,a as g,b as d,e as K,t as I,F as S,f as c,g as U,s as X,h as Y,i as Z,u as $,j as ee,k as se,l as oe,m as ne,n as r,p as F,q as x,v as H,x as G,y as te}from"./index-CEtufpFM.js";import{l as ae}from"./index-CGwCSIWv.js";const ie=W({name:"UserDialog",props:{show:{type:Boolean,default:!1},users:{type:Array,default:()=>[]}},setup(a){const s=c(a.show);return U(()=>a.show,u=>{s.value=u}),{visible:s}}}),re=g("span",{class:"p-text-secondary block mb-5"},"Users in Chat",-1);function le(a,s,u,e,p,t){const i=k("MainDialog");return l(),R(i,{visible:a.visible,"onUpdate:visible":s[0]||(s[0]=m=>a.visible=m),style:{width:"25rem"},modal:""},{header:M(()=>[re]),default:M(()=>[g("ul",null,[(l(!0),d(S,null,K(a.users,m=>(l(),d("li",{key:m.id},I(m.username),1))),128))])]),_:1},8,["visible"])}const ue=V(ie,[["render",le]]),de={components:{InputText:X,MainButton:Y,Message:Z,UserDialogComponent:ue},props:{groupId:{type:String,default:null}},setup(a){const s=c(null),u=c([]),e=c(""),p=c(!1),t=$(),i=ee(),m=c(!1),f=c([]),y=c(""),n=c([]),_=se(()=>t.token&&b(t.token)?!0:(t.clearToken(),!1)),B=()=>{s.value||(s.value=ae("http://localhost:9090"),s.value.on("message",A),s.value.on("ownMessage",q),s.value.on("ki",A),s.value.on("users",O),s.value.on("group",z),s.value.on("removeSession",()=>{t.clearToken(),i.add({severity:"warn",summary:"Session expired",life:3e3})}),s.value.on("receiveGroupMessage",L),s.value.on("ownGroupMessage",N),s.value.on("messageHistory",o=>{const h=H(t.token);u.value=o.map(v=>v.userId===h.id?{id:v.userId,text:v.content,sender:"me"}:{id:v.userId,text:v.content,sender:"other"})}),s.value.emit("join",{token:t.token}))},j=()=>{s.value&&(s.value.disconnect(),s.value=null)};oe(()=>{_.value&&(B(),s.value.emit("fetchMessages",t.token),a.groupId&&s.value.emit("joinGroup",{groupId:a.groupId,token:t.token}))}),U(()=>a.groupId,o=>{s.value&&o&&s.value.emit("joinGroup",{groupId:o,token:t.token})}),U(()=>t.token,o=>{!o||!b(o)?j():(B(),s.value.emit("fetchMessages",t.token))}),ne(()=>{j()});const z=o=>{y.value=o.groupName},E=()=>{if(_.value){if(!b(t.token)){t.clearToken();return}if(p.value&&e.value.trim()){const o={id:Date.now(),body:e.value,sender:"me",token:t.token};s.value.emit("ki",o),e.value="@ki: ";return}if(e.value.trim()){const o={id:Date.now(),body:e.value,sender:"me",token:t.token};s.value.emit("message",o),e.value=""}}},A=o=>{i.add({severity:"info",summary:"New message",detail:o.body,life:3e3}),u.value.push({id:Date.now(),text:o,sender:"other"})},q=o=>{u.value.push({id:Date.now(),text:o,sender:"me"})},O=o=>{f.value=o},J=()=>{if(_.value){if(!b(t.token)){t.clearToken();return}if(p.value&&e.value.trim()){const o={id:Date.now(),body:e.value,sender:"me",token:t.token};s.value.emit("ki",o),e.value="@ki: ";return}if(e.value.trim()){const o={id:Date.now(),body:e.value,groupId:a.groupId,sender:"me",token:t.token};s.value.emit("sendGroupMessage",o),e.value=""}}},L=o=>{n.value.push({id:Date.now(),text:o.content,sender:"other"}),i.add({severity:"info",summary:"New group message",detail:o.content,life:3e3})},N=o=>{n.value.push({id:Date.now(),text:o.content,sender:"me"})};U(e,o=>{if(!_.value)return;const h=/(\/ai|\/ki)/,v=/(\/cancel)/,P=/^@ki:/;if(!P.test(o)&&h.test(o)&&!a.groupId){const T=o.match(h);if(T){const C=T[0],D=`@ki: ${o.split(C).filter(w=>w.trim()!=="").join(" ").trim()}`;e.value!==D&&(e.value=D,p.value=!0)}}if(v.test(o)){const C=o.match(v)[0],D=o.split(C).filter(w=>w.trim()!==C)[0].split(RegExp(P)).filter(w=>w.trim()!=="").join(" ");e.value=D,p.value=!1;return}});function b(o){try{return H(o).exp>Date.now()/1e3?!0:(i.add({severity:"warn",summary:"Session expired",life:3e3}),!1)}catch{return!1}}return{messages:u,newMessage:e,isKiChat:p,chatTitle:y,groupMessages:n,sendMessage:E,sendGroupMessage:J,receiveGroupMessage:L,ownGroupMessage:N,isLoggedIn:_,showUserDialog:m,users:f}}},ce={key:0,class:"chat-container"},me={class:"bg-emerald-500 rounded-xl p-2 bg-opacity-40 hover:bg-opacity-60 absolute left-1/2 top-2 p-2"},ge={class:"messages"},pe={class:"message-content"},ve={key:0,class:"input-container"},fe={class:"input-area"},he={key:1,class:"input-container"},ke={class:"input-area"},ye={key:1,class:"chat-container"},_e={class:"messages"},we={class:"message-content"},Me={key:0,class:"input-container"},be={class:"input-area"},Ce={key:1,class:"input-container"},De={class:"input-area"};function xe(a,s,u,e,p,t){const i=k("MainButton"),m=k("InputText"),f=k("Message"),y=k("UserDialogComponent");return u.groupId?(l(),d("div",ce,[g("h1",me,I(e.chatTitle),1),r(i,{icon:"pi pi-users",class:"user-icon bg-emerald-500 rounded-xl p-2 bg-opacity-40 hover:bg-opacity-60",onClick:s[0]||(s[0]=n=>e.showUserDialog=!0)}),g("div",ge,[(l(!0),d(S,null,K(e.groupMessages,n=>(l(),d("div",{key:n.id,class:F(["message",n.sender==="me"?"sent":"received"])},[g("div",pe,I(n.text),1)],2))),128))]),e.isLoggedIn?(l(),d("div",ve,[g("div",fe,[r(m,{modelValue:e.newMessage,"onUpdate:modelValue":s[1]||(s[1]=n=>e.newMessage=n),placeholder:"Type a message",onKeyup:x(e.sendGroupMessage,["enter"])},null,8,["modelValue","onKeyup"]),r(i,{icon:"pi pi-send",onClick:e.sendGroupMessage},null,8,["onClick"])])])):(l(),d("div",he,[r(f,{closable:!1,class:"message-banner",severity:"warn"},{default:M(()=>[G(" Please Log in to chat ")]),_:1}),g("div",ke,[r(m,{modelValue:e.newMessage,"onUpdate:modelValue":s[2]||(s[2]=n=>e.newMessage=n),placeholder:"Type a message",onKeyup:x(e.sendGroupMessage,["enter"]),disabled:""},null,8,["modelValue","onKeyup"]),r(i,{icon:"pi pi-send",onClick:e.sendGroupMessage,disabled:""},null,8,["onClick"])])])),r(y,{show:e.showUserDialog,users:e.users,onHide:s[3]||(s[3]=n=>e.showUserDialog=!1)},null,8,["show","users"])])):(l(),d("div",ye,[r(i,{icon:"pi pi-users",class:"user-icon",onClick:s[4]||(s[4]=n=>e.showUserDialog=!0)}),g("div",_e,[(l(!0),d(S,null,K(e.messages,n=>(l(),d("div",{key:n.id,class:F(["message",n.sender==="me"?"sent":"received"])},[g("div",we,I(n.text),1)],2))),128))]),e.isLoggedIn?(l(),d("div",Me,[r(f,{closable:!1,class:"message-banner"},{default:M(()=>[G(" Use /ki or /ai to communicate with the AI and /cancel to cancel the chat with the AI ")]),_:1}),g("div",be,[r(m,{modelValue:e.newMessage,"onUpdate:modelValue":s[5]||(s[5]=n=>e.newMessage=n),placeholder:"Type a message",onKeyup:x(e.sendMessage,["enter"])},null,8,["modelValue","onKeyup"]),r(i,{icon:"pi pi-send",onClick:e.sendMessage},null,8,["onClick"])])])):(l(),d("div",Ce,[r(f,{closable:!1,class:"message-banner",severity:"warn"},{default:M(()=>[G(" Please Log in to chat ")]),_:1}),g("div",De,[r(m,{modelValue:e.newMessage,"onUpdate:modelValue":s[6]||(s[6]=n=>e.newMessage=n),placeholder:"Type a message",onKeyup:x(e.sendMessage,["enter"]),disabled:""},null,8,["modelValue","onKeyup"]),r(i,{icon:"pi pi-send",onClick:e.sendMessage,disabled:""},null,8,["onClick"])])])),r(y,{show:e.showUserDialog,users:e.users,onHide:s[7]||(s[7]=n=>e.showUserDialog=!1)},null,8,["show","users"])]))}const Ie=V(de,[["render",xe],["__scopeId","data-v-fd7d39a2"]]),Ue={components:{ChatComponent:Ie},setup(){const a=te(),s=c(a.params.groupId),u=c(!0),e=c(!1);return{groupId:s,register:u,showAuthDialog:e,closeAuthDialog:()=>{e.value=!1}}}};function Te(a,s,u,e,p,t){const i=k("ChatComponent");return l(),R(i,{groupId:e.groupId},null,8,["groupId"])}const Se=V(Ue,[["render",Te]]);export{Se as default};
